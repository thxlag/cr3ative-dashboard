<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cr3ative Dashboard</title>
    <!-- Use an inline data URI favicon instead of a file to avoid 404 errors -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
    <style>
      :root {
        color-scheme: dark;
        --bg: #0f172a;
        --bg-alt: #111c34;
        --card: #1e293b;
        --accent: #38bdf8;
        --accent-soft: rgba(56, 189, 248, 0.12);
        --text: #e2e8f0;
        --muted: #94a3b8;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(8, 47, 73, 0.85)), url('https://grainy-gradients.vercel.app/noise.svg');
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px 16px;
      }
      .shell {
        width: min(1100px, 100%);
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.12);
        border-radius: 24px;
        padding: 32px;
        box-shadow: 0 24px 80px rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(20px);
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 18px;
        margin-bottom: 28px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 14px;
      }
      .brand-avatar {
        width: 60px;
        height: 60px;
        border-radius: 18px;
        background: var(--accent-soft);
        display: grid;
        place-items: center;
        font-weight: 600;
        font-size: 22px;
        letter-spacing: 1px;
      }
      h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 600;
      }
      p.sub {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 15px;
      }
      .actions {
        display: flex;
        gap: 12px;
        align-items: center;
      }
      button, a.button {
        outline: none;
        border: none;
        border-radius: 14px;
        padding: 12px 20px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }
      button.primary, a.button.primary {
        background: linear-gradient(135deg, #38bdf8, #2563eb);
        color: white;
        box-shadow: 0 10px 30px rgba(37, 99, 235, 0.35);
      }
      button.primary:hover, a.button.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 40px rgba(37, 99, 235, 0.45);
      }
      button.ghost {
        background: transparent;
        color: var(--muted);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 18px;
      }
      .card {
        padding: 24px;
        border-radius: 20px;
        background: linear-gradient(160deg, rgba(30, 41, 59, 0.82), rgba(30, 64, 175, 0.18));
        border: 1px solid rgba(148, 163, 184, 0.12);
        min-height: 150px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .card h3 {
        margin: 0 0 6px;
        font-size: 17px;
        color: var(--muted);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .card .value {
        font-size: 32px;
        font-weight: 700;
      }
      .card small {
        color: var(--muted);
      }
      .status {
        border-radius: 16px;
        padding: 18px 22px;
        background: rgba(56, 189, 248, 0.08);
        border: 1px solid rgba(56, 189, 248, 0.2);
        margin-bottom: 26px;
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .status span {
        font-weight: 600;
        color: var(--accent);
      }
      .guild-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .guild-tag {
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(56, 189, 248, 0.12);
        border: 1px solid rgba(56, 189, 248, 0.25);
        color: var(--text);
        font-size: 13px;
      }
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        border-radius: 22px;
        background: rgba(148, 163, 184, 0.08);
        border: 1px dashed rgba(148, 163, 184, 0.2);
      }
      
      /* New styles for enhanced dashboard */
      .layout {
        display: flex;
        gap: 24px;
        margin-top: 20px;
      }
      
      .sidebar {
        width: 240px;
        flex-shrink: 0;
      }
      
      .main-content {
        flex-grow: 1;
      }
      
      .nav-section {
        margin-bottom: 20px;
      }
      
      .nav-section h3 {
        font-size: 14px;
        color: var(--muted);
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      
      .nav-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        border-radius: 10px;
        margin-bottom: 4px;
        cursor: pointer;
        transition: background 0.2s;
        font-weight: 500;
      }
      
      .nav-item:hover {
        background: rgba(148, 163, 184, 0.1);
      }
      
      .nav-item.active {
        background: var(--accent-soft);
        color: var(--accent);
      }
      
      .server-select {
        width: 100%;
        padding: 12px;
        background: rgba(30, 41, 59, 0.5);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        color: var(--text);
        margin-bottom: 16px;
        font-weight: 500;
      }
      
      .connection-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        margin-bottom: 20px;
      }
      
      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }
      
      .status-online {
        background: #10b981;
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
      }
      
      .status-offline {
        background: #ef4444;
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
      }
      
      .panel {
        display: none;
      }
      
      .panel.active {
        display: block;
      }
      
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      }
      
      .stat-card {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
      }
      
      .stat-card h4 {
        margin: 0 0 8px;
        color: var(--muted);
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      
      .stat-card .stat-value {
        font-size: 24px;
        font-weight: 700;
      }
      
      .chart-container {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 24px;
        height: 300px;
      }
      
      .search-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 16px;
      }
      
      .search-input {
        flex-grow: 1;
        padding: 12px 16px;
        background: rgba(30, 41, 59, 0.5);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 12px;
        color: var(--text);
      }
      
      .table-container {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 16px;
        overflow: hidden;
      }
      
      table {
        width: 100%;
        border-collapse: collapse;
      }
      
      th {
        text-align: left;
        padding: 16px;
        background: rgba(15, 23, 42, 0.5);
        color: var(--muted);
        font-weight: 600;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      
      td {
        padding: 14px 16px;
        border-top: 1px solid rgba(148, 163, 184, 0.1);
      }
      
      .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }
      
      .badge-ban {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
      }
      
      .badge-kick {
        background: rgba(249, 115, 22, 0.2);
        color: #fb923c;
      }
      
      .badge-mute {
        background: rgba(234, 179, 8, 0.2);
        color: #facc15;
      }
      
      .badge-warn {
        background: rgba(168, 85, 247, 0.2);
        color: #c084fc;
      }
      
      .settings-group {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 24px;
      }
      
      .settings-group h3 {
        margin-top: 0;
        margin-bottom: 16px;
        font-size: 18px;
        color: var(--text);
      }
      
      .form-group {
        margin-bottom: 16px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }
      
      .form-group input[type="text"],
      .form-group input[type="number"],
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        background: rgba(15, 23, 42, 0.5);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 8px;
        color: var(--text);
      }
      
      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }
      
      .toggle-group {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }
      
      .toggle-label {
        flex-grow: 1;
      }
      
      .commands-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
      }
      
      .command-item {
        background: rgba(15, 23, 42, 0.5);
        border-radius: 10px;
        padding: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .command-name {
        font-weight: 500;
      }
      
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }
      
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(148, 163, 184, 0.2);
        transition: .4s;
        border-radius: 24px;
      }
      
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: var(--text);
        transition: .4s;
        border-radius: 50%;
      }
      
      input:checked + .toggle-slider {
        background-color: var(--accent);
      }
      
      input:checked + .toggle-slider:before {
        transform: translateX(20px);
      }
      
      @media (max-width: 920px) {
        .layout {
          flex-direction: column;
        }
        
        .sidebar {
          width: 100%;
          margin-bottom: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell" id="dashboard">
      <header>
        <div class="brand">
          <div class="brand-avatar">CB</div>
          <div>
            <h1>Cr3ative Control Center</h1>
            <p class="sub">Monitor activity, tweak systems, and keep your communities humming.</p>
          </div>
        </div>
        <div class="actions" id="action-bar">
          <a class="button primary" href="/auth/login">Log in with Discord</a>
        </div>
      </header>

      <section id="status-area"></section>

      <!-- Main Dashboard Layout with Sidebar -->
      <section id="full-dashboard" style="display: none;">
        <div class="layout">
          <!-- Sidebar Navigation -->
          <div class="sidebar">
            <select class="server-select" id="server-select">
              <option value="">Select a server...</option>
            </select>
            
            <div class="connection-status">
              <div class="status-indicator status-online" id="connection-indicator"></div>
              <span id="connection-text">Bot online</span>
            </div>
            
            <div class="nav-section">
              <h3>Dashboard</h3>
              <div class="nav-item active" data-panel="overview">Overview</div>
              <div class="nav-item" data-panel="analytics">Analytics</div>
            </div>
            
            <div class="nav-section">
              <h3>Management</h3>
              <div class="nav-item" data-panel="commands">Commands</div>
              <div class="nav-item" data-panel="moderation">Moderation</div>
              <div class="nav-item" data-panel="settings">Settings</div>
            </div>
            
            <div class="nav-section">
              <h3>Configuration</h3>
              <div class="nav-item" data-panel="economy">Economy</div>
              <div class="nav-item" data-panel="casino">Casino</div>
              <div class="nav-item" data-panel="pokemon">Pok√©mon</div>
              <div class="nav-item" data-panel="jobs">Jobs</div>
              <div class="nav-item" data-panel="streaming">Streaming</div>
            </div>

            <!-- New Utilities section -->
            <div class="nav-section">
              <h3>Utilities</h3>
              <div class="nav-item" data-panel="console">Console</div>
            </div>
          </div>
          
          <!-- Main Content Area -->
          <div class="main-content">
            <!-- Overview Panel -->
            <div class="panel active" id="panel-overview">
              <h2>Overview</h2>
              
              <div class="stats-grid">
                <div class="stat-card">
                  <h4>Total Servers</h4>
                  <div class="stat-value" id="stat-servers">--</div>
                </div>
                <div class="stat-card">
                  <h4>Total Users</h4>
                  <div class="stat-value" id="stat-users">--</div>
                </div>
                <div class="stat-card">
                  <h4>Bot Latency</h4>
                  <div class="stat-value" id="stat-latency">--</div>
                </div>
                <div class="stat-card">
                  <h4>Commands Today</h4>
                  <div class="stat-value" id="stat-commands">--</div>
                </div>
              </div>
              
              <div class="chart-container">
                <h3>Top Commands</h3>
                <div id="chart-top-commands" style="height: 250px;"></div>
              </div>
              
              <div class="card">
                <h3>Quick Actions</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                  <button class="primary" id="btn-restart-bot">Restart Bot</button>
                  <button class="ghost" id="btn-sync-commands">Sync Commands</button>
                  <button class="ghost" id="btn-clear-cache">Clear Cache</button>
                </div>
              </div>
            </div>
            
            <!-- Analytics Panel -->
            <div class="panel" id="panel-analytics">
              <h2>Analytics</h2>
              
              <div class="chart-container">
                <h3>Member Growth</h3>
                <div id="chart-member-growth" style="height: 250px;"></div>
              </div>
              
              <div class="chart-container">
                <h3>Message Activity</h3>
                <div id="chart-message-activity" style="height: 250px;"></div>
              </div>
              
              <div class="chart-container">
                <h3>Role Distribution</h3>
                <div id="chart-role-distribution" style="height: 250px;"></div>
              </div>
            </div>
            
            <!-- Commands Panel -->
            <div class="panel" id="panel-commands">
              <h2>Commands Management</h2>
              
              <div class="search-bar">
                <input type="text" class="search-input" placeholder="Search commands..." id="commands-search">
                <button class="primary" id="btn-save-commands">Save Changes</button>
              </div>
              
              <div class="settings-group">
                <h3>Command Categories</h3>
                
                <div class="toggle-group">
                  <div class="toggle-label">Economy Commands</div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="toggle-category-economy" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="toggle-group">
                  <div class="toggle-label">Casino Commands</div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="toggle-category-casino" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="toggle-group">
                  <div class="toggle-label">Moderation Commands</div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="toggle-category-moderation" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="toggle-group">
                  <div class="toggle-label">Utility Commands</div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="toggle-category-utility" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="toggle-group">
                  <div class="toggle-label">Fun Commands</div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="toggle-category-fun" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
              
              <div class="settings-group">
                <h3>Individual Commands</h3>
                <div class="commands-list" id="commands-list">
                  <!-- Commands will be populated here -->
                </div>
              </div>
            </div>
            
            <!-- Moderation Panel -->
            <div class="panel" id="panel-moderation">
              <h2>Moderation Logs</h2>
              
              <div class="search-bar">
                <input type="text" class="search-input" placeholder="Search by user, moderator, or reason..." id="modlogs-search">
                <select class="search-input" style="flex-grow: 0; width: 150px;" id="modlogs-filter">
                  <option value="all">All Actions</option>
                  <option value="ban">Bans</option>
                  <option value="kick">Kicks</option>
                  <option value="mute">Mutes</option>
                  <option value="warn">Warnings</option>
                </select>
              </div>
              
              <div class="table-container">
                <table id="modlogs-table">
                  <thead>
                    <tr>
                      <th>Case ID</th>
                      <th>Action</th>
                      <th>User</th>
                      <th>Moderator</th>
                      <th>Reason</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody id="modlogs-body">
                    <!-- Moderation logs will be populated here -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Settings Panel -->
            <div class="panel" id="panel-settings">
              <h2>General Settings</h2>
              
              <div class="settings-group">
                <h3>Bot Configuration</h3>
                <form id="bot-settings-form">
                  <div class="form-group">
                    <label for="bot-prefix">Command Prefix</label>
                    <input type="text" id="bot-prefix" placeholder="!" maxlength="5">
                  </div>
                  
                  <div class="toggle-group">
                    <div class="toggle-label">Enable Slash Commands</div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="toggle-slash-commands" checked>
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                  
                  <button type="submit" class="primary">Save Bot Settings</button>
                </form>
              </div>
              
              <div class="settings-group">
                <h3>Welcome Messages</h3>
                <form id="welcome-settings-form">
                  <div class="form-group">
                    <label for="welcome-channel">Welcome Channel</label>
                    <select id="welcome-channel">
                      <option value="">Select channel...</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="welcome-message">Welcome Message</label>
                    <textarea id="welcome-message" placeholder="Welcome {user} to {server}! You are member #{count}."></textarea>
                  </div>
                  
                  <p style="color: var(--muted); font-size: 14px; margin-bottom: 20px;">
                    Available variables: {user}, {server}, {count}, {mention}
                  </p>
                  
                  <div class="toggle-group">
                    <div class="toggle-label">Enable Welcome Messages</div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="toggle-welcome" checked>
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                  
                  <button type="submit" class="primary">Save Welcome Settings</button>
                </form>
              </div>
              
              <div class="settings-group">
                <h3>Leave Messages</h3>
                <form id="leave-settings-form">
                  <div class="form-group">
                    <label for="leave-channel">Leave Channel</label>
                    <select id="leave-channel">
                      <option value="">Select channel...</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="leave-message">Leave Message</label>
                    <textarea id="leave-message" placeholder="{user} has left the server. We now have {count} members."></textarea>
                  </div>
                  
                  <p style="color: var(--muted); font-size: 14px; margin-bottom: 20px;">
                    Available variables: {user}, {server}, {count}
                  </p>
                  
                  <div class="toggle-group">
                    <div class="toggle-label">Enable Leave Messages</div>
                    <label class="toggle-switch">
                      <input type="checkbox" id="toggle-leave" checked>
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                  
                  <button type="submit" class="primary">Save Leave Settings</button>
                </form>
              </div>
              
              <div class="settings-group">
                <h3>Role Permissions</h3>
                <form id="permissions-settings-form">
                  <div class="form-group">
                    <label for="admin-role">Admin Role</label>
                    <select id="admin-role">
                      <option value="">Select role...</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="mod-role">Moderator Role</label>
                    <select id="mod-role">
                      <option value="">Select role...</option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label for="dj-role">DJ Role</label>
                    <select id="dj-role">
                      <option value="">Select role...</option>
                    </select>
                  </div>
                  
                  <button type="submit" class="primary">Save Permission Settings</button>
                </form>
              </div>
            </div>
            
            <!-- Economy Settings Panel -->
            <div class="panel" id="panel-economy">
              <h2>Economy Settings</h2>
              <div class="settings-group">
                <h3>Economy Configuration</h3>
                <form id="economy-form">
                  <div class="form-group">
                    <label for="maxDeposit">Max Deposit</label>
                    <input type="number" id="maxDeposit">
                  </div>
                  <div class="form-group">
                    <label for="taxRate">Tax Rate (%)</label>
                    <input type="number" id="taxRate" step="0.01">
                  </div>
                  <div class="form-group">
                    <label for="withdrawLimit">Withdraw Limit</label>
                    <input type="number" id="withdrawLimit">
                  </div>
                  <button type="submit" class="primary">Save Economy Settings</button>
                </form>
              </div>
            </div>
            
            <!-- Casino Settings Panel -->
            <div class="panel" id="panel-casino">
              <h2>Casino Settings</h2>
              <div class="settings-group">
                <h3>Casino Configuration</h3>
                <form id="casino-form">
                  <div class="form-group">
                    <label for="slotsRTP">Slots RTP</label>
                    <input type="number" id="slotsRTP" step="0.01">
                  </div>
                  <div class="form-group">
                    <label for="bjFee">Blackjack Fee (%)</label>
                    <input type="number" id="bjFee" step="0.01">
                  </div>
                  <div class="form-group">
                    <label for="rouletteEdge">Roulette Edge (%)</label>
                    <input type="number" id="rouletteEdge" step="0.01">
                  </div>
                  <button type="submit" class="primary">Save Casino Settings</button>
                </form>
              </div>
            </div>
            
            <!-- Pok√©mon Settings Panel -->
            <div class="panel" id="panel-pokemon">
              <h2>Pok√©mon Settings</h2>
              <div class="settings-group">
                <h3>Pok√©mon Configuration</h3>
                <form id="pokemon-form">
                  <div class="form-group">
                    <label for="spawnChance">Spawn Chance (%)</label>
                    <input type="number" id="spawnChance" step="0.01">
                  </div>
                  <div class="form-group">
                    <label for="spawnCooldown">Spawn Cooldown (s)</label>
                    <input type="number" id="spawnCooldown">
                  </div>
                  <div class="form-group">
                    <label for="despawnTime">Despawn Time (s)</label>
                    <input type="number" id="despawnTime">
                  </div>
                  <button type="submit" class="primary">Save Pok√©mon Settings</button>
                </form>
              </div>
            </div>
            
            <!-- Jobs Settings Panel -->
            <div class="panel" id="panel-jobs">
              <h2>Jobs Settings</h2>
              <div class="settings-group">
                <h3>Jobs Configuration</h3>
                <form id="jobs-form">
                  <div class="form-group">
                    <label for="streakBonus">Streak Bonus (%/day)</label>
                    <input type="number" id="streakBonus" step="0.01">
                  </div>
                  <div class="form-group">
                    <label for="skillMult">Skill Multiplier (%/level)</label>
                    <input type="number" id="skillMult" step="0.01">
                  </div>
                  <button type="submit" class="primary">Save Jobs Settings</button>
                </form>
              </div>
            </div>
            
            <!-- Streaming Settings Panel -->
            <div class="panel" id="panel-streaming">
              <h2>Streaming Settings</h2>
              <div class="settings-group">
                <h3>Streaming Configuration</h3>
                <form id="streaming-form">
                  <div class="form-group">
                    <label for="twitchChannel">Twitch Channel ID</label>
                    <input type="text" id="twitchChannel">
                  </div>
                  <div class="form-group">
                    <label for="youtubeChannel">YouTube Channel ID</label>
                    <input type="text" id="youtubeChannel">
                  </div>
                  <div class="form-group">
                    <label for="notifyChannel">Notif Channel ID</label>
                    <input type="text" id="notifyChannel">
                  </div>
                  <div class="form-group">
                    <label for="thumbInterval">Thumbnail Interval (s)</label>
                    <input type="number" id="thumbInterval">
                  </div>
                  <button type="submit" class="primary">Save Streaming Settings</button>
                </form>
              </div>
            </div>
            
            <!-- New Console Panel -->
            <div class="panel" id="panel-console">
              <h2>Console</h2>
              <div class="settings-group">
                <h3>Bot Console</h3>
                <div class="form-group">
                  <label for="console-channel">Channel</label>
                  <select id="console-channel">
                    <option value="">Select channel...</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="console-input">Message or Command</label>
                  <textarea id="console-input" placeholder="Type a message or slash-command here..."></textarea>
                </div>
                <button class="primary" id="btn-console-send">Send as Bot</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="empty-state" id="empty-state" style="display: none;">
        <p style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">You are signed in but no Manage Server guilds were detected.</p>
        <p style="color: var(--muted); margin-bottom: 20px;">Grant the bot access or invite it to the communities you manage to unlock analytics and controls.</p>
        <button class="primary" id="logout-btn">Sign out</button>
      </div>
    </div>

    <script>
      const actionBar = document.getElementById('action-bar');
      const statusArea = document.getElementById('status-area');
      const emptyState = document.getElementById('empty-state');
      const fullDashboard = document.getElementById('full-dashboard');
      const serverSelect = document.getElementById('server-select');
      const connectionIndicator = document.getElementById('connection-indicator');
      const connectionText = document.getElementById('connection-text');
      const navItems = document.querySelectorAll('.nav-item');
      const panels = document.querySelectorAll('.panel');
      let socket = null;
      let currentGuildId = null;  // track selected guild
      let reconnectAttempts = 0;  // track WebSocket reconnection attempts

      async function fetchJSON(url, options) {
        try {
          const res = await fetch(url, options);
          if (!res.ok) {
            const errorText = await res.text();
            console.error(`HTTP error! status: ${res.status}, body: ${errorText}`);
            throw new Error(`HTTP error! status: ${res.status}, body: ${errorText}`);
          }
          return res.json();
        } catch (error) {
          console.error(`API request failed for ${url}:`, error);
          throw error;
        }
      }

      // Initialize WebSocket connection
      function initWebSocket() {
        if (socket) {
          socket.close();
        }
        
        try {
          const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
          const wsUrl = `${protocol}//${window.location.host}/ws`;
          
          console.log(`Connecting to WebSocket at ${wsUrl}`);
          socket = new WebSocket(wsUrl);
          
          socket.onopen = function() {
            console.log('WebSocket connected');
            updateConnectionStatus(true);
            reconnectAttempts = 0; // Reset reconnect attempts on successful connection
            sendHeartbeat(); // Start sending heartbeats
          };
          
          socket.onclose = function(event) {
            console.log(`WebSocket disconnected. Code: ${event.code}, Reason: ${event.reason}`);
            updateConnectionStatus(false);
            
            // Exponential backoff for reconnection (max 30 seconds)
            const delay = Math.min(5000 * Math.pow(1.5, reconnectAttempts), 30000);
            reconnectAttempts++;
            console.log(`Attempting to reconnect in ${delay/1000} seconds (attempt ${reconnectAttempts})`);
            setTimeout(initWebSocket, delay);
          };
          
          socket.onmessage = function(event) {
            try {
              const data = JSON.parse(event.data);
              
              switch (data.type) {
                case 'stats':
                  updateStats(data.payload);
                  break;
                case 'modlog':
                  addModLogEntry(data.payload);
                  break;
                case 'botStatus':
                  updateConnectionStatus(data.payload.online);
                  break;
                default:
                  console.log('Received WebSocket message:', data);
              }
            } catch (error) {
              console.error('Error processing WebSocket message:', error, event.data);
            }
          };

          socket.onerror = function(error) {
            console.error('WebSocket error:', error);
          };
        } catch (error) {
          console.error('Failed to initialize WebSocket:', error);
          // Still try to reconnect
          setTimeout(initWebSocket, 5000);
        }
      }

      // Heartbeat mechanism
      function sendHeartbeat() {
        if (socket && socket.readyState === WebSocket.OPEN) {
          try {
            socket.send(JSON.stringify({ type: 'heartbeat' }));
          } catch (error) {
            console.error('Error sending heartbeat:', error);
          }
        }
        setTimeout(sendHeartbeat, 30000); // Send heartbeat every 30 seconds
      }
      
      function updateConnectionStatus(online) {
        if (connectionIndicator && connectionText) {
          if (online) {
            connectionIndicator.className = 'status-indicator status-online';
            connectionText.textContent = 'Bot online';
          } else {
            connectionIndicator.className = 'status-indicator status-offline';
            connectionText.textContent = 'Bot offline';
          }
        }
      }
      
      // Navigation between panels
      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const targetPanel = item.getAttribute('data-panel');
          
          // Update active nav item
          navItems.forEach(nav => nav.classList.remove('active'));
          item.classList.add('active');
          
          // Show target panel, hide others
          panels.forEach(panel => {
            if (panel.id === `panel-${targetPanel}`) {
              panel.classList.add('active');
            } else {
              panel.classList.remove('active');
            }
          });
        });
      });
      
      // Load server list
      async function loadServerList() {
        try {
          const guilds = await fetchJSON('/api/admin/guilds');
          if (!serverSelect) return;

          serverSelect.innerHTML = '';
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = 'Select a server...';
          placeholder.disabled = guilds.length === 1;
          placeholder.hidden = guilds.length === 1;
          serverSelect.appendChild(placeholder);

          guilds.forEach(guild => {
            const option = document.createElement('option');
            option.value = guild.id;
            option.textContent = guild.name;
            serverSelect.appendChild(option);
          });

          if (guilds.length === 1) {
            serverSelect.value = guilds[0].id;
            serverSelect.disabled = true;
            await loadGuildData(guilds[0].id);
            if (connectionText) {
              connectionText.textContent = guilds[0].name;
            }
          }

          if (!serverSelect.hasAttribute('data-listener')) {
            serverSelect.addEventListener('change', () => {
              const guildId = serverSelect.value;
              if (guildId) {
                loadGuildData(guildId);
              }
            });
            serverSelect.setAttribute('data-listener', 'true');
          }

          if (guilds.length > 1 && !serverSelect.value && guilds[0]) {
            serverSelect.value = guilds[0].id;
            loadGuildData(guilds[0].id);
          }
        } catch (error) {
          console.error('Failed to load server list:', error);
          statusArea.innerHTML += '<div class="status" style="background: rgba(248, 113, 113, 0.12); border-color: rgba(248, 113, 113, 0.45); color: #fca5a5;">Failed to load server list. Check console for details.</div>';
        }
      }
      
      // Load guild-specific data
      async function loadGuildData(guildId) {
        try {
          currentGuildId = guildId;
          const guildData = await fetchJSON(`/api/admin/guilds/${guildId}`);
          
          // Update stats - with null checking
          const memberCountElement = document.getElementById('stat-users');
          if (memberCountElement && guildData && guildData.memberCount !== undefined) {
            memberCountElement.textContent = new Intl.NumberFormat().format(guildData.memberCount);
          }
          
          // Update channels and roles dropdowns - with null checking
          if (guildData.channels) updateChannelsDropdown(guildData.channels);
          if (guildData.roles) updateRolesDropdown(guildData.roles);
          if (guildData.channels) updateConsoleDropdown(guildData.channels);
          
          // Load command settings
          loadCommandSettings(guildId);
          
          // Load moderation logs
          loadModerationLogs(guildId);
          
          // Load guild settings
          loadGuildSettings(guildId);
        } catch (error) {
          console.error('Failed to load guild data:', error);
          statusArea.innerHTML += `<div class="status" style="background: rgba(248, 113, 113, 0.12); border-color: rgba(248, 113, 113, 0.45); color: #fca5a5;">Failed to load data for guild ${guildId}. Check console for details.</div>`;
        }
      }
      
      // Update channels dropdown
      function updateChannelsDropdown(channels) {
        try {
          const welcomeChannel = document.getElementById('welcome-channel');
          const leaveChannel = document.getElementById('leave-channel');
          
          if (!welcomeChannel || !leaveChannel) return;
          
          welcomeChannel.innerHTML = '<option value="">Select channel...</option>';
          leaveChannel.innerHTML = '<option value="">Select channel...</option>';
          
          channels.forEach(channel => {
            if (channel.type === 'GUILD_TEXT' || channel.type === 0) { // 0 is GUILD_TEXT in newer Discord API
              const option1 = document.createElement('option');
              option1.value = channel.id;
              option1.textContent = `#${channel.name}`;
              welcomeChannel.appendChild(option1);
              
              const option2 = document.createElement('option');
              option2.value = channel.id;
              option2.textContent = `#${channel.name}`;
              leaveChannel.appendChild(option2);
            }
          });
        } catch (error) {
          console.error('Failed to update channels dropdown:', error);
        }
      }
      
      // Update roles dropdown
      function updateRolesDropdown(roles) {
        try {
          const adminRole = document.getElementById('admin-role');
          const modRole = document.getElementById('mod-role');
          const djRole = document.getElementById('dj-role');
          
          if (!adminRole || !modRole || !djRole) return;
          
          adminRole.innerHTML = '<option value="">Select role...</option>';
          modRole.innerHTML = '<option value="">Select role...</option>';
          djRole.innerHTML = '<option value="">Select role...</option>';
          
          roles.forEach(role => {
            const option1 = document.createElement('option');
            option1.value = role.id;
            option1.textContent = role.name;
            adminRole.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = role.id;
            option2.textContent = role.name;
            modRole.appendChild(option2);
            
            const option3 = document.createElement('option');
            option3.value = role.id;
            option3.textContent = role.name;
            djRole.appendChild(option3);
          });
        } catch (error) {
          console.error('Failed to update roles dropdown:', error);
        }
      }
      
      // Update console channel dropdown - new function
      function updateConsoleDropdown(channels) {
        try {
          const consoleChannel = document.getElementById('console-channel');
          if (!consoleChannel) return;
          
          consoleChannel.innerHTML = '<option value="">Select channel...</option>';
          
          channels.forEach(channel => {
            if (channel.type === 'GUILD_TEXT' || channel.type === 0) {
              const option = document.createElement('option');
              option.value = channel.id;
              option.textContent = `#${channel.name}`;
              consoleChannel.appendChild(option);
            }
          });
        } catch (error) {
          console.error('Failed to update console dropdown:', error);
        }
      }
      
      // Load command settings
      async function loadCommandSettings(guildId) {
        try {
          const commands = await fetchJSON(`/api/admin/guilds/${guildId}/commands`);
          const commandsList = document.getElementById('commands-list');
          
          if (!commandsList) return;
          
          commandsList.innerHTML = '';
          
          if (!commands || !Array.isArray(commands) || commands.length === 0) {
            commandsList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted);">No commands available or commands data could not be loaded.</div>';
            return;
          }
          
          commands.forEach(command => {
            const commandItem = document.createElement('div');
            commandItem.className = 'command-item';
            commandItem.innerHTML = `
              <div class="command-name">${command.name || 'Unknown'}</div>
              <label class="toggle-switch">
                <input type="checkbox" data-command="${command.id}" ${command.enabled ? 'checked' : ''}>
                <span class="toggle-slider"></span>
              </label>
            `;
            commandsList.appendChild(commandItem);
          });
          
          // Category toggles
          document.querySelectorAll('[id^="toggle-category-"]').forEach(toggle => {
            toggle.addEventListener('change', function() {
              const category = this.id.replace('toggle-category-', '');
              const categoryCommands = commands.filter(cmd => cmd.category === category);
              const categoryCommandIds = categoryCommands.map(cmd => cmd.id);
              
              document.querySelectorAll(`[data-command]`).forEach(checkbox => {
                if (categoryCommandIds.includes(checkbox.getAttribute('data-command'))) {
                  checkbox.checked = this.checked;
                }
              });
            });
          });
          
          // Save button
          const saveBtn = document.getElementById('btn-save-commands');
          if (saveBtn) {
            saveBtn.addEventListener('click', async () => {
              const updatedCommands = [];
              
              document.querySelectorAll('[data-command]').forEach(checkbox => {
                updatedCommands.push({
                  id: checkbox.getAttribute('data-command'),
                  enabled: checkbox.checked
                });
              });
              
              try {
                await fetchJSON(`/api/admin/guilds/${guildId}/commands`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ commands: updatedCommands })
                });
                
                alert('Command settings saved successfully!');
              } catch (error) {
                console.error('Failed to save command settings:', error);
                alert('Failed to save command settings. Please try again.');
              }
            });
          }
        } catch (error) {
          console.error('Failed to load command settings:', error);
          const commandsList = document.getElementById('commands-list');
          if (commandsList) {
            commandsList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted);">Failed to load commands. Check console for details.</div>';
          }
        }
      }
      
      // Load moderation logs
      async function loadModerationLogs(guildId) {
        try {
          const modlogs = await fetchJSON(`/api/admin/guilds/${guildId}/modlogs`);
          const modlogsBody = document.getElementById('modlogs-body');
          
          if (!modlogsBody) return;
          
          modlogsBody.innerHTML = '';
          
          if (!modlogs || !Array.isArray(modlogs) || modlogs.length === 0) {
            modlogsBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--muted);">No moderation logs available.</td></tr>';
            return;
          }
          
          modlogs.forEach(log => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${log.caseId || 'N/A'}</td>
              <td><span class="badge badge-${(log.action || 'unknown').toLowerCase()}">${log.action || 'Unknown'}</span></td>
              <td>${log.user || 'Unknown'}</td>
              <td>${log.moderator || 'System'}</td>
              <td>${log.reason || '<em>No reason provided</em>'}</td>
              <td>${log.timestamp ? new Date(log.timestamp).toLocaleString() : 'Unknown'}</td>
            `;
            modlogsBody.appendChild(row);
          });
          
          // Search and filter
          const search = document.getElementById('modlogs-search');
          const filter = document.getElementById('modlogs-filter');
          
          if (!search || !filter) return;
          
          function filterModlogs() {
            const searchTerm = search.value.toLowerCase();
            const filterValue = filter.value;
            
            Array.from(modlogsBody.children).forEach(row => {
              if (row.children.length < 6) return; // Skip invalid rows
              
              const action = row.children[1].textContent.toLowerCase();
              const user = row.children[2].textContent.toLowerCase();
              const moderator = row.children[3].textContent.toLowerCase();
              const reason = row.children[4].textContent.toLowerCase();
              
              const matchesSearch = !searchTerm || 
                user.includes(searchTerm) || 
                moderator.includes(searchTerm) || 
                reason.includes(searchTerm);
                
              const matchesFilter = filterValue === 'all' || action === filterValue;
              
              row.style.display = matchesSearch && matchesFilter ? '' : 'none';
            });
          }
          
          search.addEventListener('input', filterModlogs);
          filter.addEventListener('change', filterModlogs);
        } catch (error) {
          console.error('Failed to load moderation logs:', error);
          const modlogsBody = document.getElementById('modlogs-body');
          if (modlogsBody) {
            modlogsBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--muted);">Failed to load moderation logs. Check console for details.</td></tr>';
          }
        }
      }
      
      // Load guild settings
      async function loadGuildSettings(guildId) {
        try {
          const settings = await fetchJSON(`/api/admin/guilds/${guildId}/settings`);
          
          // Only set values if elements and settings exist
          const botPrefix = document.getElementById('bot-prefix');
          if (botPrefix) botPrefix.value = settings?.prefix || '!';
          
          const toggleSlashCommands = document.getElementById('toggle-slash-commands');
          if (toggleSlashCommands) toggleSlashCommands.checked = settings?.slashCommands !== false;
          
          const welcomeChannel = document.getElementById('welcome-channel');
          if (welcomeChannel) welcomeChannel.value = settings?.welcomeChannelId || '';
          
          const welcomeMessage = document.getElementById('welcome-message');
          if (welcomeMessage) welcomeMessage.value = settings?.welcomeMessage || '';
          
          const toggleWelcome = document.getElementById('toggle-welcome');
          if (toggleWelcome) toggleWelcome.checked = settings?.welcomeEnabled !== false;
          
          const leaveChannel = document.getElementById('leave-channel');
          if (leaveChannel) leaveChannel.value = settings?.leaveChannelId || '';
          
          const leaveMessage = document.getElementById('leave-message');
          if (leaveMessage) leaveMessage.value = settings?.leaveMessage || '';
          
          const toggleLeave = document.getElementById('toggle-leave');
          if (toggleLeave) toggleLeave.checked = settings?.leaveEnabled !== false;
          
          const adminRole = document.getElementById('admin-role');
          if (adminRole) adminRole.value = settings?.adminRoleId || '';
          
          const modRole = document.getElementById('mod-role');
          if (modRole) modRole.value = settings?.modRoleId || '';
          
          const djRole = document.getElementById('dj-role');
          if (djRole) djRole.value = settings?.djRoleId || '';
          
          // Setup form submission handlers
          setupFormSubmitHandlers(guildId);
        } catch (error) {
          console.error('Failed to load guild settings:', error);
        }
      }
      
      // Setup form submission handlers - separate function for cleaner code
      function setupFormSubmitHandlers(guildId) {
        // Bot settings form
        const botSettingsForm = document.getElementById('bot-settings-form');
        if (botSettingsForm) {
          botSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const botPrefix = document.getElementById('bot-prefix');
            const toggleSlashCommands = document.getElementById('toggle-slash-commands');
            
            if (!botPrefix || !toggleSlashCommands) return;
            
            const botSettings = {
              prefix: botPrefix.value,
              slashCommands: toggleSlashCommands.checked
            };
            
            try {
              await fetchJSON(`/api/admin/guilds/${guildId}/settings/bot`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(botSettings)
              });
              
              alert('Bot settings saved successfully!');
            } catch (error) {
              console.error('Failed to save bot settings:', error);
              alert('Failed to save bot settings. Please try again.');
            }
          });
        }
        
        // Welcome settings form
        const welcomeSettingsForm = document.getElementById('welcome-settings-form');
        if (welcomeSettingsForm) {
          welcomeSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const welcomeChannel = document.getElementById('welcome-channel');
            const welcomeMessage = document.getElementById('welcome-message');
            const toggleWelcome = document.getElementById('toggle-welcome');
            
            if (!welcomeChannel || !welcomeMessage || !toggleWelcome) return;
            
            const welcomeSettings = {
              welcomeChannelId: welcomeChannel.value,
              welcomeMessage: welcomeMessage.value,
              welcomeEnabled: toggleWelcome.checked
            };
            
            try {
              await fetchJSON(`/api/admin/guilds/${guildId}/settings/welcome`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(welcomeSettings)
              });
              
              alert('Welcome settings saved successfully!');
            } catch (error) {
              console.error('Failed to save welcome settings:', error);
              alert('Failed to save welcome settings. Please try again.');
            }
          });
        }
        
        // Leave settings form
        const leaveSettingsForm = document.getElementById('leave-settings-form');
        if (leaveSettingsForm) {
          leaveSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const leaveChannel = document.getElementById('leave-channel');
            const leaveMessage = document.getElementById('leave-message');
            const toggleLeave = document.getElementById('toggle-leave');
            
            if (!leaveChannel || !leaveMessage || !toggleLeave) return;
            
            const leaveSettings = {
              leaveChannelId: leaveChannel.value,
              leaveMessage: leaveMessage.value,
              leaveEnabled: toggleLeave.checked
            };
            
            try {
              await fetchJSON(`/api/admin/guilds/${guildId}/settings/leave`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(leaveSettings)
              });
              
              alert('Leave settings saved successfully!');
            } catch (error) {
              console.error('Failed to save leave settings:', error);
              alert('Failed to save leave settings. Please try again.');
            }
          });
        }
        
        // Permissions settings form
        const permissionsSettingsForm = document.getElementById('permissions-settings-form');
        if (permissionsSettingsForm) {
          permissionsSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const adminRole = document.getElementById('admin-role');
            const modRole = document.getElementById('mod-role');
            const djRole = document.getElementById('dj-role');
            
            if (!adminRole || !modRole || !djRole) return;
            
            const permissionSettings = {
              adminRoleId: adminRole.value,
              modRoleId: modRole.value,
              djRoleId: djRole.value
            };
            
            try {
              await fetchJSON(`/api/admin/guilds/${guildId}/settings/permissions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(permissionSettings)
              });
              
              alert('Permission settings saved successfully!');
            } catch (error) {
              console.error('Failed to save permission settings:', error);
              alert('Failed to save permission settings. Please try again.');
            }
          });
        }
      }
      
      // Load global bot stats
      async function loadGlobalStats() {
        try {
          const stats = await fetchJSON('/api/admin/stats');
          
          // Safely update stats with null checking
          const updateElement = (id, value, formatter = null) => {
            const element = document.getElementById(id);
            if (element && value !== undefined) {
              element.textContent = formatter ? formatter(value) : value;
            }
          };
          
          const numberFormatter = new Intl.NumberFormat().format;
          
          updateElement('stat-servers', stats?.servers, numberFormatter);
          updateElement('stat-users', stats?.users, numberFormatter);
          updateElement('stat-latency', stats?.latency, (val) => `${val} ms`);
          updateElement('stat-commands', stats?.commandsToday, numberFormatter);
          
          // Handle memberGrowth chart - this is likely where the error occurs
          handleCharts(stats);
          
        } catch (error) {
          console.error('Failed to load global stats:', error);
          // Show error message to user
          statusArea.innerHTML += '<div class="status" style="background: rgba(248, 113, 113, 0.12); border-color: rgba(248, 113, 113, 0.45); color: #fca5a5;">Failed to load global stats. Check console for details.</div>';
        }
      }
      
      // Safely handle chart data initialization
      function handleCharts(stats) {
        try {
          // For now, we'll just add placeholder content to chart containers
          // since we don't have Chart.js integrated
          const chartContainers = [
            'chart-top-commands',
            'chart-member-growth',
            'chart-message-activity',
            'chart-role-distribution'
          ];
          
          chartContainers.forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
              container.innerHTML = '<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: var(--muted);">Chart data loading... <br>(or Chart.js integration missing)</div>';
            }
          });
          
          // Log chart data to console for debugging
          console.log('Chart data available:', { 
            memberGrowth: stats?.memberStats?.memberGrowth || 'N/A',
            messageActivity: stats?.messageStats?.activity || 'N/A',
            topCommands: stats?.topCommands || 'N/A',
            roleDistribution: stats?.roleStats?.distribution || 'N/A'
          });
          
        } catch (error) {
          console.error('Failed to initialize charts:', error);
        }
      }
      
      // Add a new modlog entry (for real-time updates)
      function addModLogEntry(log) {
        if (!log) return;
        
        const modlogsBody = document.getElementById('modlogs-body');
        
        if (modlogsBody) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${log.caseId || 'N/A'}</td>
            <td><span class="badge badge-${(log.action || 'unknown').toLowerCase()}">${log.action || 'Unknown'}</span></td>
            <td>${log.user || 'Unknown'}</td>
            <td>${log.moderator || 'System'}</td>
            <td>${log.reason || '<em>No reason provided</em>'}</td>
            <td>${log.timestamp ? new Date(log.timestamp).toLocaleString() : 'Unknown'}</td>
          `;
          
          // Insert at the top
          if (modlogsBody.firstChild) {
            modlogsBody.insertBefore(row, modlogsBody.firstChild);
          } else {
            modlogsBody.appendChild(row);
          }
        }
      }

      async function logout() {
        try {
          await fetchJSON('/auth/logout', { method: 'POST' });
        } catch (error) {
          console.error('logout failed', error);
        }
        showLogin();
      }

      function showLogin() {
        // hide inner panels, keep outer shell visible
        if (emptyState) emptyState.style.display = 'none';
        if (fullDashboard) fullDashboard.style.display = 'none';

        actionBar.innerHTML = '<a class="button primary" href="/auth/login">Log in with Discord</a>';
        statusArea.innerHTML = '';

        if (socket) {
          socket.close();
          socket = null;
        }
      }

      function renderSession(user) {
        actionBar.innerHTML = `
          <button class="ghost" id="refresh-btn">Refresh</button>
          <button class="primary" id="logout-btn">Sign out</button>
        `;
        document.getElementById('refresh-btn').addEventListener('click', () => init());
        document.getElementById('logout-btn').addEventListener('click', logout);

        statusArea.innerHTML = `
          <div class="status">
            <div>
              <strong>${user.username}</strong>
              <span>signed in</span>
            </div>
            <div style="color: var(--muted);">
              ${user.adminGuilds.length} guild${user.adminGuilds.length === 1 ? '' : 's'} with Manage Server
            </div>
          </div>
        `;
      }

      async function init() {
        try {
          console.log('Dashboard initializing...');
          const session = await fetchJSON('/auth/session');
          if (!session.authenticated) {
            console.log('User not authenticated, showing login');
            showLogin();
            return;
          }

          console.log('User authenticated:', session.user.username);
          renderSession(session.user);

          if (!session.user.adminGuilds.length) {
            // no guilds ‚Üí show empty state
            console.log('No admin guilds found, showing empty state');
            if (emptyState) emptyState.style.display = 'block';
            if (fullDashboard) fullDashboard.style.display = 'none';
            return;
          }

          // authenticated & has guilds ‚Üí show full dashboard
          console.log('Admin guilds found, showing dashboard');
          if (emptyState) emptyState.style.display = 'none';
          if (fullDashboard) fullDashboard.style.display = 'block';

          loadServerList();
          loadGlobalStats();
          initWebSocket();
        } catch (error) {
          console.error('dashboard init failed', error);
          showLogin();
          statusArea.innerHTML = '<div class="status" style="background: rgba(248, 113, 113, 0.12); border-color: rgba(248, 113, 113, 0.45); color: #fca5a5;">Unable to connect to dashboard API. Check console for details.</div>';
        }
      }

      // Add missing updateStats function with defensive coding
      function updateStats(data) {
        if (!data) {
          console.warn('Received empty stats data');
          return;
        }
        
        try {
          // Update server count
          const serversElement = document.getElementById('stat-servers');
          if (serversElement && data.servers !== undefined) {
            serversElement.textContent = new Intl.NumberFormat().format(data.servers);
          }
          
          // Update user count
          const usersElement = document.getElementById('stat-users');
          if (usersElement && data.users !== undefined) {
            usersElement.textContent = new Intl.NumberFormat().format(data.users);
          }
          
          // Update latency
          const latencyElement = document.getElementById('stat-latency');
          if (latencyElement && data.latency !== undefined) {
            latencyElement.textContent = `${data.latency} ms`;
          }
          
          // Update commands today
          const commandsElement = document.getElementById('stat-commands');
          if (commandsElement && data.commandsToday !== undefined) {
            commandsElement.textContent = new Intl.NumberFormat().format(data.commandsToday);
          }
          
          // Update charts if needed
          handleCharts(data);
        } catch (error) {
          console.error('Error updating stats:', error);
        }
      }
      
      // Setup console message sending
      const consoleSendBtn = document.getElementById('btn-console-send');
      if (consoleSendBtn) {
        consoleSendBtn.addEventListener('click', async () => {
          const channelId = document.getElementById('console-channel')?.value;
          const content = document.getElementById('console-input')?.value?.trim();
          
          if (!currentGuildId || !channelId || !content) {
            return alert('Select a server, channel, and enter a message.');
          }
          
          try {
            await fetchJSON(`/api/admin/guilds/${currentGuildId}/console`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ channelId, content })
            });
            
            alert('Message sent!');
            const consoleInput = document.getElementById('console-input');
            if (consoleInput) consoleInput.value = '';
          } catch (err) {
            console.error('Console send failed:', err);
            alert('Failed to send message. Check console.');
          }
        });
      }
      
      // Add event listeners for quick action buttons
      const restartBtn = document.getElementById('btn-restart-bot');
      if (restartBtn) {
        restartBtn.addEventListener('click', async () => {
          if (!confirm('Are you sure you want to restart the bot?')) return;
          
          try {
            await fetchJSON('/api/admin/restart', { method: 'POST' });
            alert('Bot restart initiated!');
          } catch (err) {
            console.error('Bot restart failed:', err);
            alert('Failed to restart bot. Check console.');
          }
        });
      }
      
      const syncCommandsBtn = document.getElementById('btn-sync-commands');
      if (syncCommandsBtn) {
        syncCommandsBtn.addEventListener('click', async () => {
          try {
            await fetchJSON('/api/admin/sync-commands', { method: 'POST' });
            alert('Commands synchronized successfully!');
          } catch (err) {
            console.error('Command sync failed:', err);
            alert('Failed to sync commands. Check console.');
          }
        });
      }
      
      const clearCacheBtn = document.getElementById('btn-clear-cache');
      if (clearCacheBtn) {
        clearCacheBtn.addEventListener('click', async () => {
          try {
            await fetchJSON('/api/admin/clear-cache', { method: 'POST' });
            alert('Cache cleared successfully!');
          } catch (err) {
            console.error('Cache clear failed:', err);
            alert('Failed to clear cache. Check console.');
          }
        });
      }
      
      // Start the application
      console.log('Starting dashboard application...');
      window.addEventListener('load', init);
    </script>
  </body>
</html>
